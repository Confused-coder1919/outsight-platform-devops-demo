name: CI

on:
  push:
    branches: [main]
    # Avoid infinite loops when the GitOps PR only updates tenant values.
    paths-ignore:
      - "gitops/tenants/**"
  pull_request:

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          # requirements-dev.txt includes requirements.txt
          pip install -r requirements-dev.txt
      - name: Lint
        run: ruff check .
      - name: Test
        run: pytest -q

  build-and-publish:
    runs-on: ubuntu-latest
    needs: test
    # Only publish on main to avoid pushing images from untrusted forks.
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Compute lowercase image repo
        run: |
          REPO_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "IMAGE_REPO=ghcr.io/${REPO_LOWER}/demo-api" >> "$GITHUB_ENV"
          echo "IMAGE_TAG=sha-${SHORT_SHA}" >> "$GITHUB_ENV"
          echo "SHORT_SHA=${SHORT_SHA}" >> "$GITHUB_ENV"
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # GITHUB_TOKEN has packages: write permission from the workflow.
          password: ${{ github.token }}
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_REPO }}:latest
      - name: Install yq
        run: |
          curl -sSL https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -o /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
      - name: Update tenant values with new image
        run: |
          yq -i '.image.repository = env(IMAGE_REPO) | .image.tag = env(IMAGE_TAG)' gitops/tenants/tenant-a-values.yaml
          yq -i '.image.repository = env(IMAGE_REPO) | .image.tag = env(IMAGE_TAG)' gitops/tenants/tenant-b-values.yaml
      - name: Create PR with updated image tags
        id: gitops_pr
        uses: peter-evans/create-pull-request@v6
        if: ${{ github.event.repository.fork == false && !startsWith(github.ref, 'refs/heads/ci/update-image-') }}
        continue-on-error: true
        with:
          # GitOps changes flow through a PR for auditability.
          branch: "ci/update-image-${{ env.SHORT_SHA }}"
          commit-message: "chore(gitops): update demo-api image to ${{ env.IMAGE_TAG }}"
          title: "chore(gitops): update demo-api image to ${{ env.IMAGE_TAG }}"
          body: "Automated image tag update from CI."
          labels: "ci"
          add-paths: |
            gitops/tenants/tenant-a-values.yaml
            gitops/tenants/tenant-b-values.yaml
      - name: Report GitOps PR creation failure
        if: steps.gitops_pr.outcome == 'failure'
        run: |
          echo "GitOps PR creation failed. Ensure the workflow has contents: write and pull-requests: write permissions."
          echo "If this is a fork, PR creation is intentionally skipped."
